<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Camara de Comercio de Medellin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap para estilos rápidos -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-3">Buscador de laudos arbitrales - Camara de Comercio de Medellin</h1>
      <p class="text-muted mb-4">
        Busca por radicado, partes, resumen o etiqueta. Usa los filtros para acotar los resultados.
      </p>

      <!-- Barra superior: búsqueda + orden -->
      <form method="get" class="mb-3" id="search-form">
        <div class="row g-3 align-items-end">
          <!-- Palabras clave -->
          <div class="col-md-6">
            <label for="q" class="form-label">Palabras clave</label>
            <input
              type="text"
              id="q"
              name="q"
              class="form-control"
              placeholder="Buscar por radicado, partes, texto del laudo o etiqueta…"
              value="{{ q }}"
            >
          </div>

          <!-- Orden -->
          <div class="col-md-3">
            <label for="sort" class="form-label">Ordenar por</label>
            <select
              class="form-select"
              id="sort"
              name="sort"
            >
              <option value="fecha_desc" {% if sort == 'fecha_desc' %}selected{% endif %}>
                Más recientes primero
              </option>
              <option value="fecha_asc" {% if sort == 'fecha_asc' %}selected{% endif %}>
                Más antiguos primero
              </option>
              <option value="radicado_asc" {% if sort == 'radicado_asc' %}selected{% endif %}>
                Radicado (A → Z)
              </option>
            </select>
          </div>

          <!-- Botón buscar -->
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">
              Buscar
            </button>
          </div>
        </div>

        <!-- Filtros por etiquetas -->
        <div class="mt-3">
          <label class="form-label d-block">Filtrar por etiquetas</label>
          <div class="d-flex flex-wrap">
            {% for tag in tags %}
              <div class="form-check me-3 mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="tag"
                  id="tag-{{ tag.id }}"
                  value="{{ tag.id }}"
                  {% if tag.id in selected_tag_ids %}checked{% endif %}
                >
                <label class="form-check-label" for="tag-{{ tag.id }}">
                  {{ tag.name }}
                </label>
              </div>
            {% endfor %}
          </div>
        </div>
      </form>

      <!-- Filtros activos + limpiar -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          {% if selected_tag_ids or q %}
            <span class="me-2 fw-semibold">Filtros activos:</span>
          {% endif %}

          {% if q %}
            <span class="badge rounded-pill text-bg-primary me-1">
              Búsqueda: “{{ q }}”
            </span>
          {% endif %}

          {% for tag in tags %}
            {% if tag.id in selected_tag_ids %}
              <span class="badge rounded-pill text-bg-secondary me-1">
                {{ tag.name }}
              </span>
            {% endif %}
          {% endfor %}
        </div>

        <div>
          {% if q or selected_tag_ids %}
            <a href="{{ url_for('search') }}" class="btn btn-sm btn-outline-secondary">
              Limpiar filtros
            </a>
          {% endif %}
        </div>
      </div>

      <!-- Resumen de resultados -->
      {% set total = pagination.total if pagination is defined else results|length %}
      {% if total > 0 and pagination is defined %}
        {% set start = (pagination.page - 1) * per_page + 1 %}
        {% set end = (pagination.page - 1) * per_page + results|length %}
        <p class="text-muted mb-3">
          Mostrando <strong>{{ start }}–{{ end }}</strong> de <strong>{{ total }}</strong> resultado{{ 's' if total != 1 }}{% if q %} para “{{ q }}”{% endif %}.
        </p>
      {% elif total == 0 %}
        <p class="text-muted mb-3">
          No se encontraron resultados{% if q %} para “{{ q }}”{% endif %}. Ajusta las palabras clave o los filtros.
        </p>
      {% endif %}

      <!-- Lista de resultados -->
      {% if results %}
        <ul class="list-group mb-4">
          {% for case in results %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div class="me-3">
                  <!-- Radicado y fecha del laudo -->
                  <p class="mb-1 small text-muted">
                    <strong>Radicado:</strong> {{ case.radicado }}
                    {% if case.fecha_laudo %}
                      · <strong>Laudo:</strong>
                      {{ case.fecha_laudo.strftime('%d/%m/%Y') }}
                    {% endif %}
                  </p>

                  <h3 class="h6 mb-1">{{ case.title }}</h3>

                  <p class="mb-1 small text-muted">
                    {% for tag in case.tags %}
                      <span class="badge text-bg-secondary me-1">{{ tag.name }}</span>
                    {% endfor %}
                  </p>

                  <p class="mb-0">
                    {{ case.content[:260] }}{% if case.content|length > 260 %}…{% endif %}
                  </p>
                </div>

                {% if case.doc_filename %}
                  <div class="text-nowrap">
                    <a
                      href="{{ url_for('download_case', case_id=case.id) }}"
                      class="btn btn-sm btn-outline-secondary"
                    >
                      Descargar laudo
                    </a>
                  </div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      <!-- Paginación -->
      {% if pagination.pages > 1 %}
        <nav aria-label="Paginación de resultados">
          <ul class="pagination justify-content-center">
            <!-- Página anterior -->
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
              {% if pagination.has_prev %}
                <a
                  class="page-link"
                  href="{{ request.path }}?q={{ q }}&sort={{ sort }}{% for id in selected_tag_ids %}&tag={{ id }}{% endfor %}&page={{ pagination.prev_num }}"
                  aria-label="Anterior"
                >
                  &laquo;
                </a>
              {% else %}
                <span class="page-link">&laquo;</span>
              {% endif %}
            </li>

            <!-- Números de página (simple: todas las páginas si son pocas) -->
            {% for p in range(1, pagination.pages + 1) %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                {% if p == pagination.page %}
                  <span class="page-link">{{ p }}</span>
                {% else %}
                  <a
                    class="page-link"
                    href="{{ request.path }}?q={{ q }}&sort={{ sort }}{% for id in selected_tag_ids %}&tag={{ id }}{% endfor %}&page={{ p }}"
                  >
                    {{ p }}
                  </a>
                {% endif %}
              </li>
            {% endfor %}

            <!-- Página siguiente -->
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
              {% if pagination.has_next %}
                <a
                  class="page-link"
                  href="{{ request.path }}?q={{ q }}&sort={{ sort }}{% for id in selected_tag_ids %}&tag={{ id }}{% endfor %}&page={{ pagination.next_num }}"
                  aria-label="Siguiente"
                >
                  &raquo;
                </a>
              {% else %}
                <span class="page-link">&raquo;</span>
              {% endif %}
            </li>
          </ul>
        </nav>
      {% endif %}
    </div>

    <!-- Auto-submit al cambiar el orden -->
    <script>
      const sortSelect = document.getElementById('sort');
      const searchForm = document.getElementById('search-form');

      if (sortSelect && searchForm) {
        sortSelect.addEventListener('change', function () {
          searchForm.submit();
        });
      }
    </script>
  </body>
</html>

